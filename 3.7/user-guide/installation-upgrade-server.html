<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Upgrading an ANNIS Server installation - ANNIS User Guide</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="installation-kickstarter.html"><strong aria-hidden="true">2.1.</strong> Installing a Local Version (ANNIS Kickstarter)</a></li><li class="chapter-item expanded "><a href="installation-server.html"><strong aria-hidden="true">2.2.</strong> Installing an ANNIS Server</a></li><li class="chapter-item expanded "><a href="installation-upgrade-server.html" class="active"><strong aria-hidden="true">2.3.</strong> Upgrading an ANNIS Server installation</a></li></ol></li><li class="chapter-item expanded "><a href="interface.html"><strong aria-hidden="true">3.</strong> Using the ANNIS interface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="interface-search-form.html"><strong aria-hidden="true">3.1.</strong> Search Form</a></li><li class="chapter-item expanded "><a href="interface-result-window.html"><strong aria-hidden="true">3.2.</strong> Result Window</a></li><li class="chapter-item expanded "><a href="interface-query-builder.html"><strong aria-hidden="true">3.3.</strong> Query Builder</a></li></ol></li><li class="chapter-item expanded "><a href="aql.html"><strong aria-hidden="true">4.</strong> ANNIS Query Language (AQL)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="aql-word-forms.html"><strong aria-hidden="true">4.1.</strong> Searching for Word Forms</a></li><li class="chapter-item expanded "><a href="aql-annotations.html"><strong aria-hidden="true">4.2.</strong> Searching for Annotations</a></li><li class="chapter-item expanded "><a href="aql-regex.html"><strong aria-hidden="true">4.3.</strong> Searching using Regular Expressions</a></li><li class="chapter-item expanded "><a href="aql-trees.html"><strong aria-hidden="true">4.4.</strong> Searching for Trees</a></li><li class="chapter-item expanded "><a href="aql-pointing.html"><strong aria-hidden="true">4.5.</strong> Searching for Pointing Relations</a></li><li class="chapter-item expanded "><a href="aql-export.html"><strong aria-hidden="true">4.6.</strong> Exporting Results</a></li><li class="chapter-item expanded "><a href="aql-frequency.html"><strong aria-hidden="true">4.7.</strong> Frequency Analysis</a></li><li class="chapter-item expanded "><a href="aql-operators.html"><strong aria-hidden="true">4.8.</strong> Complete List of Operators</a></li></ol></li><li class="chapter-item expanded "><a href="visualizations.html"><strong aria-hidden="true">5.</strong> Configuring Visualizations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="visualizations-list.html"><strong aria-hidden="true">5.1.</strong> List of Visualizations</a></li><li class="chapter-item expanded "><a href="visualizations-context.html"><strong aria-hidden="true">5.2.</strong> Maximal Context Size, Context Steps and Result Page Sizes</a></li><li class="chapter-item expanded "><a href="visualizations-documentbrowser.html"><strong aria-hidden="true">5.3.</strong> Document Browser</a></li><li class="chapter-item expanded "><a href="visualizations-rtl.html"><strong aria-hidden="true">5.4.</strong> Right-to-Left Visualizations</a></li></ol></li><li class="chapter-item expanded "><a href="import-and-config.html"><strong aria-hidden="true">6.</strong> Importing and Configuring Corpora</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="import-and-config-convert.html"><strong aria-hidden="true">6.1.</strong> Converting Corpora for ANNIS using Pepper</a></li><li class="chapter-item expanded "><a href="import-and-config-import.html"><strong aria-hidden="true">6.2.</strong> Importing Corpora in the relANNIS format</a></li><li class="chapter-item expanded "><a href="import-and-config-corpus-config.html"><strong aria-hidden="true">6.3.</strong> Configuring Settings for a Corpus</a></li><li class="chapter-item expanded "><a href="import-and-config-instances.html"><strong aria-hidden="true">6.4.</strong> Multiple Instances of the Interface</a></li><li class="chapter-item expanded "><a href="import-and-config-user.html"><strong aria-hidden="true">6.5.</strong> User Configuration</a></li><li class="chapter-item expanded "><a href="import-and-config-admin-web.html"><strong aria-hidden="true">6.6.</strong> The administration web interface</a></li></ol></li><li class="chapter-item expanded "><a href="advanced.html"><strong aria-hidden="true">7.</strong> Advanced Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="advanced-postgresql.html"><strong aria-hidden="true">7.1.</strong> PostgreSQL Server Configuration</a></li><li class="chapter-item expanded "><a href="advanced-errorcodes.html"><strong aria-hidden="true">7.2.</strong> Error Codes of the administration tools</a></li><li class="chapter-item expanded "><a href="advanced-custom-login.html"><strong aria-hidden="true">7.3.</strong> Provide your own login-system</a></li><li class="chapter-item expanded "><a href="advanced-links-to-queries.html"><strong aria-hidden="true">7.4.</strong> Links to queries</a></li><li class="chapter-item expanded "><a href="advanced-embed-vis.html"><strong aria-hidden="true">7.5.</strong> Embed ANNIS visualizations</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">ANNIS User Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#upgrading-an-annis-server-installation" id="upgrading-an-annis-server-installation">Upgrading an ANNIS Server installation</a></h1>
<p>These instructions are a guideline for upgrading the installation of ANNIS on a UNIX-like server. 
If you use the <a href="installation-kickstarter.html">ANNIS Kickstarter version</a> 
just download the new version and re-initialize the database.
Please read <a href="installation-server.html">the installation instructions</a> first if you
haven't done so yet.</p>
<h2><a class="header" href="#automatic-upgrade" id="automatic-upgrade">Automatic upgrade</a></h2>
<p>Upgrading the ANNIS service is more complex than deploying the user interface WAR file.
Therefore a Python script is available for an automatic upgrade. This script needs as least Python 3.2.</p>
<ol>
<li>Download the <a href="https://raw.githubusercontent.com/korpling/ANNIS/master/Misc/upgrade_service.py">latest version of the script</a>. </li>
<li>Download the new ANNIS release files (<code>annis-service-&lt;VERSION&gt;.tar.gz</code> and <code>annis-gui-&lt;VERSION&gt;.war</code>) </li>
<li>Run the script 
<pre><code class="language-bash">python3 upgrade_service.py --cleanup-data &lt;installation-directory&gt; annis-service-&lt;VERSION&gt;.tar.gz
</code></pre>
If the new release uses a new database schema the update might take some time. Thus it might be better to execute the script in the background:
<pre><code class="language-bash">nohup python3 upgrade_service.py --cleanup-data &lt;installation-directory&gt; annis-service-&lt;VERSION&gt;.tar.gz &amp;
tail -f nohup.out
</code></pre>
</li>
<li>If successful undeploy the old WAR file and deploy the new one.</li>
</ol>
<p>In case the upgrade script needed to update the database (it will tell you so), 
you should delete the old schema from your PostgreSQL database by running the 
following command in your PostgreSQL-Client:</p>
<pre><code class="language-sql">DROP SCHEMA &lt;oldschema&gt;;
</code></pre>
<p><em><strong>Note:</strong></em> To learn more about the (additional) parameters of the script run: </p>
<pre><code class="language-bash">python3 upgrade_service.py --help
</code></pre>
<h2><a class="header" href="#manual-upgrade" id="manual-upgrade">Manual upgrade</a></h2>
<p>When Python is not available it is still possible to execute the steps
of the upgrade process manually.
The upgrade path described here tries to have a minimum downtime.</p>
<h3><a class="header" href="#upgrade-for-minor-version-updates" id="upgrade-for-minor-version-updates">Upgrade for minor version updates</a></h3>
<p>For minor version updates, e.g. from 3.1.0 to 3.1.1 (thus only
the last version number changes) you can use the database from the older version
without any modifications. Thus an upgrade only consists of the following steps</p>
<ol>
<li>backup the old installation files</li>
<li>download the files of the new version</li>
<li>backup the <code>conf/database.properties</code> file of the ANNIS service</li>
<li>if you made any manual adjustments to the file <code>conf/annis-service.properties</code> also backup it </li>
<li>stop the old ANNIS service</li>
<li>overwrite the files of the old ANNIS service installation with the new version</li>
<li>overwrite the <code>conf/database.properties</code> file with the backup</li>
<li>apply the changes you made to the <code>conf/annis-service.properties</code> on the new version (e.g. set the port number)</li>
<li>start the ANNIS service again</li>
<li>undeploy the old WAR file and deploy the new WAR file</li>
</ol>
<h3><a class="header" href="#full-upgrade" id="full-upgrade">Full upgrade</a></h3>
<p>Whenever the first or second number of the version changes you have to re-import
the corpora into a newly initialized database.</p>
<h4><a class="header" href="#1-download" id="1-download">1. Download</a></h4>
<p>Download both the <code>annis-service-&lt;VERSION&gt;.tar.gz</code> and the <code>annis-gui-&lt;VERSION&gt;.war</code>
to a folder of your choice, e.g. <code>/tmp/</code>.</p>
<h4><a class="header" href="#2-install-the-new-service" id="2-install-the-new-service">2. Install the new service</a></h4>
<p>Unzip the annis service to a new  directory (don't delete or stop the old service)
and install it. 
These steps are similiar to how to [install a new ANNIS service](@ref admin-install-server).
\code{.sh}
tar xvzf /tmp/annis-service-<VERSION>.tar.gz -C <new installation directory>
export ANNIS_HOME=<new installation directory>&gt;
export PATH=$PATH:$ANNIS_HOME/bin
\endcode
If you made any manual changes to the <code>conf/annis-service.properties</code> file copy
the changes to the new installation.
Then initialize the the database for the new installation.
\code{.sh}
annis-admin.sh init -u <username> -d <dbname> -p <user password> --schema <new schema name>
\endcode
Please re-use the old database name, the user name and the password for the existing user (they can be found
in the <code>conf/database.properties</code> file of the old installation).
The parameter <code>--schema</code> allows you to define a new <a href="http://www.postgresql.org/docs/9.6/static/ddl-schemas.html">PostgreSQL schema</a>
which will be used for the new installation. 
A good name could be something like &quot;v32&quot; if the version is 3.2.0.</p>
<h4><a class="header" href="#3-copy-old-corpora" id="3-copy-old-corpora">3. Copy old corpora</a></h4>
<p>With the command
\code{.sh}
annis-admin.sh copy <old installation director>/conf/database.properties
\endcode
the existing corpora of the old installation will be imported. This
can take a long time, so if you use SSH you might want use <code>nohup</code> to make sure 
the process will continue to run in the background even if the connection is interrupted.
\code{.sh}
nohup annis-admin.sh copy <old installation director>/conf/database.properties &amp;
tail -f nohup.out
\endcode
At the end a summary of all successfull and failed imports 
will be given. If there where any errors please try to import the corpus
manually. When all corpora are imported, proceed to the next step.</p>
<p>Additionally copy  the &quot;user_config&quot; and &quot;url_shortener&quot; tables from the
old installation, e.g. with the <a href="http://www.postgresql.org/docs/9.6/static/sql-copy.html#AEN69268">PostgreSQL <code>COPY</code> command</a></p>
<h4><a class="header" href="#4-switch-service" id="4-switch-service">4. Switch service</a></h4>
<p>Stop the old service and start the
new service. Remember to set the <code>ANNIS_HOME</code> variable to the right value in
both cases before you call <code>annis-service.sh start/stop</code> command.</p>
<h4><a class="header" href="#5-upgrade-front-end" id="5-upgrade-front-end">5. Upgrade front-end</a></h4>
<p>Undeploy the old WAR file and deploy the new WAR file.</p>
<h4><a class="header" href="#6-cleanup" id="6-cleanup">6. Cleanup</a></h4>
<p>If everything works as expected you can delete the old installation files. You
should also remove the contents of the old database by deleting the schema from the
PostgreSQL client:</p>
<pre><code class="language-sql">DROP SCHEMA &lt;oldschema&gt;;
</code></pre>
<p>To delete all unused external data files execute</p>
<pre><code class="language-bash">annis-admin.sh cleanup-data
</code></pre>
<p>\warning This will delete all data files not known to the current instance of ANNIS.
If you have multiple parallel installations and did not use different values for
the <code>annis.external-data-path</code> variable in the <code>conf/annis-service.properties</code>
the data files of the other installations will be lost.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="installation-server.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="interface.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="installation-server.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="interface.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
