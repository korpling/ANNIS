<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>User Configuration on Server - ANNIS User Guide</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="expanded "><a href="../installation/index.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li><ol class="section"><li class="expanded "><a href="../installation/desktop.html"><strong aria-hidden="true">2.1.</strong> Installing a Local Version (ANNIS Desktop)</a></li><li class="expanded "><a href="../installation/server.html"><strong aria-hidden="true">2.2.</strong> Installing an ANNIS Server</a></li><li class="expanded "><a href="../installation/migrate-annis3.html"><strong aria-hidden="true">2.3.</strong> Migrating from ANNIS 3</a></li></ol></li><li class="expanded "><a href="../interface/index.html"><strong aria-hidden="true">3.</strong> Using the ANNIS interface</a></li><li><ol class="section"><li class="expanded "><a href="../interface/search-form.html"><strong aria-hidden="true">3.1.</strong> Search Form</a></li><li class="expanded "><a href="../interface/result-window.html"><strong aria-hidden="true">3.2.</strong> Result Window</a></li><li class="expanded "><a href="../interface/query-builder.html"><strong aria-hidden="true">3.3.</strong> Query Builder</a></li><li class="expanded "><a href="../interface/admin-web.html"><strong aria-hidden="true">3.4.</strong> Administration Interface</a></li></ol></li><li class="expanded "><a href="../aql/index.html"><strong aria-hidden="true">4.</strong> ANNIS Query Language (AQL)</a></li><li><ol class="section"><li class="expanded "><a href="../aql/word-forms.html"><strong aria-hidden="true">4.1.</strong> Searching for Word Forms</a></li><li class="expanded "><a href="../aql/annotations.html"><strong aria-hidden="true">4.2.</strong> Searching for Annotations</a></li><li class="expanded "><a href="../aql/regex.html"><strong aria-hidden="true">4.3.</strong> Searching using Regular Expressions</a></li><li class="expanded "><a href="../aql/trees.html"><strong aria-hidden="true">4.4.</strong> Searching for Trees</a></li><li class="expanded "><a href="../aql/pointing.html"><strong aria-hidden="true">4.5.</strong> Searching for Pointing Relations</a></li><li class="expanded "><a href="../aql/export.html"><strong aria-hidden="true">4.6.</strong> Exporting Results</a></li><li class="expanded "><a href="../aql/frequency.html"><strong aria-hidden="true">4.7.</strong> Frequency Analysis</a></li><li class="expanded "><a href="../aql/operators.html"><strong aria-hidden="true">4.8.</strong> Complete List of Operators</a></li><li class="expanded "><a href="../aql/compatibility-mode.html"><strong aria-hidden="true">4.9.</strong> Differences in Compatibility Mode</a></li></ol></li><li class="expanded "><a href="../import-and-config/index.html"><strong aria-hidden="true">5.</strong> Importing and Configuring Corpora</a></li><li><ol class="section"><li class="expanded "><a href="../import-and-config/convert.html"><strong aria-hidden="true">5.1.</strong> Converting Corpora for ANNIS using Pepper</a></li><li class="expanded "><a href="../import-and-config/import.html"><strong aria-hidden="true">5.2.</strong> Importing Corpora in the relANNIS format</a></li><li class="expanded "><a href="../import-and-config/corpus-config.html"><strong aria-hidden="true">5.3.</strong> Configuring Settings for a Corpus</a></li><li class="expanded "><a href="../import-and-config/visualizations.html"><strong aria-hidden="true">5.4.</strong> Configuring Visualizations</a></li><li class="expanded "><a href="../import-and-config/visualizations-list.html"><strong aria-hidden="true">5.5.</strong> List of Visualizations</a></li><li class="expanded "><a href="../import-and-config/documentbrowser.html"><strong aria-hidden="true">5.6.</strong> Document Browser</a></li></ol></li><li class="expanded "><a href="../configuration/index.html"><strong aria-hidden="true">6.</strong> Configuration of ANNIS</a></li><li><ol class="section"><li class="expanded "><a href="../configuration/user.html" class="active"><strong aria-hidden="true">6.1.</strong> User Configuration on Server</a></li><li class="expanded "><a href="../configuration/instances.html"><strong aria-hidden="true">6.2.</strong> Multiple Instances of the Interface</a></li><li class="expanded "><a href="../configuration/rtl.html"><strong aria-hidden="true">6.3.</strong> Right-to-Left Visualizations</a></li></ol></li><li class="expanded "><a href="../advanced/index.html"><strong aria-hidden="true">7.</strong> Advanced Topics</a></li><li><ol class="section"><li class="expanded "><a href="../advanced/links-to-queries.html"><strong aria-hidden="true">7.1.</strong> Links to queries</a></li><li class="expanded "><a href="../advanced/embed-vis.html"><strong aria-hidden="true">7.2.</strong> Embed ANNIS visualizations</a></li><li class="expanded "><a href="../advanced/backend-frontend-separation.html"><strong aria-hidden="true">7.3.</strong> Install backend and front-end on different servers</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">ANNIS User Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#user-configuration-on-server" id="user-configuration-on-server">User Configuration on Server</a></h1>
<p>ANNIS has an authorization system based on <a href="https://www.oauth.com/">OAuth2</a> which allows handling multiple users on a server installation using an external identity provider service.
A user will see different corpora depending on which groups the user is part of.
<strong>For the desktop version of ANNIS, a single administrator user is automatically created and logged in.</strong></p>
<p>When using an identity provider, the backend graphANNIS service and the ANNIS frontend needs to be configured to use this service.
Per default, ANNIS uses an embedded graphANNIS service with the configuration located in the home directory of the user running the ANNIS service: <code>~/.annis/service.toml</code>.
See the <a href="https://korpling.github.io/graphANNIS/docs/v0.30/rest/auth.html">graphANNIS documentation on authentication and authorization</a> for how to use this configuration file to configure the backend.
You can choose from various OAuth2 compatible identity providers, but in the following example we will use a self-hosted <a href="https://www.keycloak.org/">Keycloak</a> server.</p>
<h2><a class="header" href="#configure-login-with-a-self-hosted-keycloak-server" id="configure-login-with-a-self-hosted-keycloak-server">Configure Login with a self-hosted Keycloak server</a></h2>
<h3><a class="header" href="#install-and-run-keycloak" id="install-and-run-keycloak">Install and run Keycloak</a></h3>
<p>Follow the <a href="https://www.keycloak.org/getting-started">&quot;Getting Started with Keycloak&quot;</a> guide to install and run the service.</p>
<h3><a class="header" href="#configure-keycloak-for-annis" id="configure-keycloak-for-annis">Configure Keycloak for ANNIS</a></h3>
<p>Keycloak uses so-called “Realms” to distinguish between different settings.
Download the realm-configuration file for ANNIS from our repository: <a href="https://raw.githubusercontent.com/korpling/ANNIS/master/misc/keycloak-realm-configuration.json">https://raw.githubusercontent.com/korpling/ANNIS/master/misc/keycloak-realm-configuration.json</a>.
We will add a realm for ANNIS by hovering over the realm selection in the top left menu and clicking on “Add realm”.</p>
<p><img src="add-realm.png" alt="Screenshot of the &quot;Add realm&quot; button in Keycloak realm selection menu" /></p>
<p>Then select this file in “Import”.</p>
<p><img src="import-realm.png" alt="Screenshot of the empty realm import page" /></p>
<p>The import page will fill out the name of the realm and list other settings under “View details“.
Click on “Create“ to create the realm.</p>
<p><img src="import-realm-filled-out.png" alt="Screenshot of the filled out realm import page" /></p>
<p>In the realm settings, click on “Keys“ and select “Public Key“</p>
<p><img src="realm-keys.png" alt="Screenshot of the key overview page for the realm" /></p>
<p>The displayed text is a public key that the graphANNIS REST service needs to verify a user presents a valid authorization token.
Add the following the Keycloak public to your <code>~/.annis/service.toml</code> file (if it does not exist yet, create it):</p>
<pre><code class="language-toml">[auth.token_verification]
type = &quot;RS256&quot;
public_key = &quot;&quot;&quot;
-----BEGIN PUBLIC KEY-----
&lt;insert copied public key from Keycloak here&gt;
-----END PUBLIC KEY-----
&quot;&quot;&quot;
</code></pre>
<p>Now create a first administrator user by selecting “Mange -&gt; Users“ in the main Keycloak menu and clicking on the “Add user“ button on the right.</p>
<p><img src="add-user-button.png" alt="Screenshot of the user overview page for the realm" /></p>
<p>Fill out the user information and click on “Create“.</p>
<p><img src="filled-out-user.png" alt="Screenshot of the initial user configuration" /></p>
<p>After creating the user, switch to the “Credentials“ tab and set a new password.
Make sure to <strong>unselect</strong> the “Temporary“ switch.</p>
<p><img src="set-password.png" alt="Screenshot how the credentials tab with a filled out password" /></p>
<p>Then add the <code>admin</code> role to this user by switching to the “Role Mappings“ tab, selecting <code>admin</code> under “Available roles“ and click on “Add selected“.</p>
<p><img src="add-role.png" alt="Screenshot the role mappings tab" /></p>
<p>The Keycloak server needs to know which URIs are valid client URIs. Go to “Configure -&gt; Clients“, select the “annis” client and replace the <code>http://localhost:5712</code> part of the “Valid Redirect URIs“ with the public URI of the ANNIS frontend.</p>
<p><img src="replace-redirect-uri.png" alt="Screenshot the valid redirection URI setting" /></p>
<h3><a class="header" href="#configure-the-annis-frontend-service" id="configure-the-annis-frontend-service">Configure the ANNIS frontend service</a></h3>
<p>Edit the application property file (e.g. <code>application.properties</code> in the working directory).</p>
<p>Add the following lines to configure ANNIS to use the Keycloak server:</p>
<pre><code class="language-properties">spring.security.oauth2.client.registration.keycloak.client-id=annis
spring.security.oauth2.client.registration.keycloak.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.keycloak.redirect-uri-template=http://localhost:5712/login/oauth2/code/keycloak
spring.security.oauth2.client.provider.keycloak.issuer-uri=http://localhost:8080/auth/realms/ANNIS
</code></pre>
<p>Replace the <code>http://localhost:5712/</code> in the <code>redirect-uri-template</code> with the public URL of your ANNIS service.
Also replace the <code>http://localhost:8080/</code> part of the <code>issuer-uri</code> with the public URL of your Keycloak server (if you are testing this on your local computer, you can leave the values as they are).</p>
<p>ANNIS uses the Spring Security framework for OAuth2 internally.
An overview of the configuration parameters is part of the <a href="https://docs.spring.io/spring-boot/docs/2.3.x/reference/html/spring-boot-features.html#boot-features-security-oauth2">Spring documentation</a>.</p>
<h3><a class="header" href="#start-the-annis-service-and-test-the-login" id="start-the-annis-service-and-test-the-login">Start the ANNIS service and test the login</a></h3>
<p>When you start the ANNIS service and open it in the browser, you should now see a “Login“ button.
Click on it and enter the credentials of the previously created adminstrator user.</p>
<p>Logging in should enable the “Administration“ interface, which you can use to assign groups to corpora.
The imported realm already has the <code>internal</code> group which you can assign to users that e.g. should have access to internal corpora.
You can create new groups and users in the Keycloak interface, assign users to groups and assign corpora to groups in the ANNIS interface.</p>
<h3><a class="header" href="#integrating-third-party-identity-providers" id="integrating-third-party-identity-providers">Integrating third party identity providers</a></h3>
<p>Keycloak also supports integrating third party identity providers like e.g. GitHub or Google.
You can manage them in the “Identity Providers“ menu in Keycloak.
The “User Federation“ menu allows to add LDAP servers which can be used as source for user accounts.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../configuration/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../configuration/instances.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../configuration/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../configuration/instances.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
